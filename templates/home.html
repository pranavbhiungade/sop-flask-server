<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grouped SOPs - Home</title>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Nunito", sans-serif; font-optical-sizing: auto;  font-style: normal; background: #121212; margin: 0; padding: 0; color: #e0e0e0; }
    .container { max-width: 1450px; margin: 40px auto; background: #1e1e1e; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.6); padding: 32px; }
    h1 { color: #00bcd4; text-align: center; margin-bottom: 24px; }
    h3 { margin: 24px 0 12px 0; color: #ffffff; font-weight: bold; text-align: left; border-left: 4px solid #00bcd4; padding-left: 10px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 24px; border: 1px solid #333; background: #1a1a1a; }
    th, td { border: 1px solid #333; padding: 10px 12px; text-align: left; font-size: 14px; color: #e0e0e0; }
    th { background: #2c2c2c; font-weight: 600; color: #00bcd4; }
    tr:nth-child(even) { background: #2a2a2a; }
    tr:nth-child(odd) { background: #1e1e1e; }
    tr:hover { background: #333; }
    a { color: #03a9f4; text-decoration: none; }
    a:hover { text-decoration: underline; color: #29b6f6; }
    .loading, .no-data { text-align: center; padding: 20px; font-style: italic; color: #aaa; }
    .action-btn { padding: 6px 10px; margin: 0 4px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .edit-btn { background: #2196f3; color: white; }
    .edit-btn:hover { background: #42a5f5; }
    .delete-btn { background: #f44336; color: white; }
    .delete-btn:hover { background: #ef5350; }
    .open-sop-btn { background: #0ea5e9; color: #fff; border-radius: 6px; padding: 6px 10px; font-size: 13px; border: none; cursor: pointer; }
    .open-sop-btn:hover { opacity: 0.95; }
    /* Modal override to use dark theme */
    .modal-bg { background: #121212; color: #e0e0e0; }
    .modal-card { background: #1f1f1f; color: #e0e0e0; border-radius: 8px; padding: 16px; }
    .back-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
    }
  </style>
</head>
<body>
   <!-- Users Page Button -->
  <div class="back-btn">
  <a href="users.html" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-gray-700 rounded-lg hover:bg-gray-600" style="text-decoration: none;color: white;">
    <span class="mr-2">Users</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
    </svg>
  </a>
</div>


  <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

  <div class="container">
    <h1 style="font-size: 48px; color:white" >ActionMap</h1>

    <div class="flex items-center gap-4">

  <button id="dropdownDividerButton" data-dropdown-toggle="dropdownDivider" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
    Services
    <svg class="w-2.5 h-2.5 ms-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
    </svg>
  </button>

  <button type="button" onclick="showAddSOPModal()" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
    <svg class="w-4 h-4 mr-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
    </svg>
    Add SOP
  </button>

</div>

<div id="dropdownDivider" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-sm w-56 dark:bg-gray-700 dark:divide-gray-600">
    <ul id="services-list" class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDividerButton">
      <li>
        <a href="#" class="block px-4 py-2 text-gray-400">Loading...</a>
      </li>
    </ul>
    
    <div class="py-2">
      <a href="#" onclick="showAddServiceModal()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white">
  <svg class="w-4 h-4 mr-2 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
  </svg>
  Add Service
</a>
    </div>
</div>

<!-- Add Service Modal -->
<div id="add-service-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-50">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Add Service
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="hideAddServiceModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <!-- Modal Body -->
      <form id="add-service-form" class="p-4 space-y-4" onsubmit="submitAddService(event)">
        <div>
          <label for="service-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Service Name</label>
          <input type="text" id="service-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" placeholder="Enter service name" required>
        </div>
        <div>
          <label for="service-version" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Version</label>
          <input type="text" id="service-version" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" placeholder="Enter version" required>
        </div>
        <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
          Add Service
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Add SOP Modal -->
<div id="add-sop-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-60">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Add SOP
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="hideAddSOPModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <form id="add-sop-form" class="p-4 md:p-5 space-y-4" onsubmit="submitAddSOP(event)">
        <div>
          <label for="add-sop-service" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Service</label>
          <select id="add-sop-service" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
            <option value="">Select a service</option>
          </select>
        </div>
        <div>
          <label for="add-sop-alert" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Alert Name</label>
          <input type="text" id="add-sop-alert" placeholder="e.g., High CPU Utilization" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
        </div>
        <div>
          <label for="add-sop-title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Title</label>
          <input type="text" id="add-sop-title" placeholder="e.g., SOP for High CPU on Web Servers" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
        </div>
        <div>
          <label for="add-sop-description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Description</label>
          <textarea id="add-sop-description" rows="2" placeholder="Describe the purpose and steps of this SOP..." class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required></textarea>
        </div>
        <div>
          <label for="add-sop-link" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">SOP Link</label>
          <textarea type="text" id="add-sop-link" placeholder="https://your-wiki.com/sop-link" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
        </div>
        
        <div>
          <label for="add-sop-daemon-tool-service" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Daemon Tool Service</label>
          <input type="text" id="add-sop-daemon-tool-service" placeholder="e.g., systemd-service-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white">
        </div>

        <div>
          <label for="add-sop-script-summary" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Script Summary</label>
          <textarea id="add-sop-script-summary" rows="4" placeholder="Brief summary of the automation script logic..." class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
        </div>
        
        <div>
          <label for="add-sop-created-by" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Created By</label>
          <select id="add-sop-created-by" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
            <option value="">Select a user</option>
          </select>
        </div>
        <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
          Add SOP
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Modal ends -->

    <form id="search-form" class="max-w-md mx-auto my-6">
  <label for="default-search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">Search</label>
  <div class="relative">
    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
      <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
      </svg>
    </div>
    <input type="search" id="default-search" class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Enter Alert Name" required />
    <button type="submit" class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Search</button>
  </div>

  <!-- Hit/Refresh Button (hidden initially) -->
  <div id="refresh-container" class="mt-4 text-center" style="display: none;">
    <button type="button" id="refresh-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
      Back
    </button>
  </div>
</form>

    <div id="sops-content" class="loading">Loading...</div>
   
  </div>

  <!-- Delete Confirmation Modal -->
<div id="popup-modal" tabindex="-1"  class="hidden fixed inset-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-50">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
      <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="popup-modal" onclick="hideDeleteModal()">
        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
        </svg>
        <span class="sr-only">Close modal</span>
      </button>
      <div class="p-4 md:p-5 text-center">
        <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
        </svg>
        <h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Are you sure you want to delete this SOP?</h3>
        <button id="confirm-delete-btn" type="button" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center">
          Yes, I'm sure
        </button>
        <button type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700" onclick="hideDeleteModal()">No, cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
  let deleteSOPId = null;
  let allSOPData = []; // store all fetched SOPs
  let currentFilter = ""; // search term

  async function fetchGroupedSOPs() {
    try {
      const response = await fetch("http://192.168.64.1:5000/home");
      if (!response.ok) throw new Error("Network response was not ok");

      const data = await response.json();
      allSOPData = data; // store globally
      renderSOPs(allSOPData);
    } catch (error) {
      document.getElementById("sops-content").innerHTML =
        '<div class="no-data">❌ Failed to load SOPs. Please try again.</div>';
      console.error("Error fetching SOPs:", error);
    }
  }

  function renderSOPs(data) {
    const container = document.getElementById("sops-content");
    container.innerHTML = "";

    if (!data.length) {
      container.innerHTML = '<div class="no-data">⚠️ No SOPs found.</div>';
      return;
    }

    let html = "";

    data.forEach(serviceObj => {
      serviceObj.versions.forEach(versionObj => {
        // Filter SOPs if search is applied
        const filteredSOPs = versionObj.sops.filter(sop =>
          sop.alert_name?.toLowerCase().includes(currentFilter.toLowerCase())
        );

        if (filteredSOPs.length === 0) return; // skip if no match
        const versionHeadingText = (versionObj.version === "0")
                                   ? "" // Omit version if it's "0"
                                   : ` | ${escapeHtml(versionObj.version)}`; 

        html += `<h3>${escapeHtml(serviceObj.service)}${versionHeadingText}</h3>`;
        html += `<div style="overflow-x:auto;"><table><thead><tr>

          <th>Alert Name</th>
          <th>Title</th>
          <th>Description</th>
          <th>Daemon Tool Service</th>
          <th>Script Summary</th>
          <th>SOP Link</th>
          <th>Created By</th>
          <th>Last Modified By</th>
          <th>Created At</th>
          <th>Updated At</th>
          <th>Actions</th>
        </tr></thead><tbody>`;

        filteredSOPs.forEach(sop => {
          const sopData = encodeURIComponent(JSON.stringify(sop));
          html += `<tr>

            <td>${escapeHtml(sop.alert_name || '-')}</td>
            <td>${escapeHtml(sop.sop_title || '-')}</td>
            <td>${escapeHtml(sop.sop_description || '-')}</td>
            
            <td>${escapeHtml(sop.daemon_tool_service || '-')}</td>
           <td>
  <button 
    type="button" 
    title="Show Script Summary"
    onclick="showScriptSummaryModal('${escapeHtml(sop.script_summary || 'No summary provided')}')"
    class="block mx-auto p-1 rounded-full 
           text-gray-800 dark:text-white 
           hover:text-blue-500 dark:hover:text-blue-400 
           hover:scale-110 
           transition duration-150 ease-in-out">
    
    <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 20 20">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H4m12 0-4 4m4-4-4-4m3-4h2a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3h-2"/>
    </svg>
  </button>
</td>
           

            <td>
  ${sop.sop_link ? `
    <a href="${escapeHtml(sop.sop_link)}" target="_blank" class="open-sop-link flex items-center gap-1 text-blue-600 hover:underline">
      Open
      <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.213 9.787a3.391 3.391 0 0 0-4.795 0l-3.425 3.426a3.39 3.39 0 0 0 4.795 4.794l.321-.304m-.321-4.49a3.39 3.39 0 0 0 4.795 0l3.424-3.426a3.39 3.39 0 0 0-4.794-4.795l-1.028.961"/>
</svg>

    </a>
  ` : '-'}
</td>

            <td>${escapeHtml(sop.created_by || '-')}</td>
            <td>${escapeHtml(sop.last_modified_by || '-')}</td>
            <td>${escapeHtml(sop.created_at || '-')}</td>
            <td>${escapeHtml(sop.updated_at || '-')}</td>
            <td style="display:flex;gap:8px;align-items:center;justify-content:left;">
              <button class="action-btn edit-btn" title="Edit" onclick='openEditModal(${JSON.stringify(sop)})'>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M4 21h17v2H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h2v2H4v17zm16.7-13.3a1 1 0 0 0 0-1.4l-2-2a1 1 0 0 0-1.4 0l-9.6 9.6a1 1 0 0 0-.3.6l-.7 4.2a1 1 0 0 0 1.2 1.2l4.2-.7a1 1 0 0 0 .6-.3l9.6-9.6zm-3.3-1.3 2 2-1.3 1.3-2-2L17.4 6.4zm-9 9 6.6-6.6 2 2-6.6 6.6-2.5.4.5-2.4z"/></svg>
              </button>
              <button class="action-btn delete-btn" title="Delete" onclick="deleteSOP(${sop.id})">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M5 6h14v2H5V6zm2 3h10l-1.5 12.5a1 1 0 0 1-1 .5h-5a1 1 0 0 1-1-.5L7 9zm3 2v7h2v-7h-2z"/></svg></button>
            </td>
          </tr>`;
        });

        html += `</tbody></table></div>`;
      });
    });

    container.innerHTML = html;

    // reattach events
    document.querySelectorAll('.open-sop-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const encoded = btn.getAttribute('data-sop');
        if (!encoded) return;
        // Ensure showSOPModal is also updated to display the new fields!
        showSOPModal(encoded);
      });
    });
  }

  // Handle search form
  document.querySelector("form").addEventListener("submit", (e) => {
    e.preventDefault();
    const searchInput = document.getElementById("default-search").value.trim();
    currentFilter = searchInput;
    renderSOPs(allSOPData);
  });

  // --- Other existing functions unchanged ---
  function deleteSOP(id) {
    deleteSOPId = id;
    document.getElementById('popup-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function hideDeleteModal() {
    document.getElementById('popup-modal').classList.add('hidden');
    document.body.style.overflow = '';
    deleteSOPId = null;
  }

  document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
    if (deleteSOPId !== null) {
      try {
        const response = await fetch(`http://192.168.64.1:5000/sops/${deleteSOPId}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" }
        });

        if (!response.ok) {
          const error = await response.json();
          showToast("❌ Failed to delete SOP: " + (error.error || response.statusText), "error");
          return;
        }

        const result = await response.json();
        showToast(result.message, "success");

        // Refresh SOP list
        fetchGroupedSOPs();
      } catch (err) {
        console.error("Delete error:", err);
        alert("❌ Error deleting SOP.");
      } finally {
        hideDeleteModal();
      }
    }
  });

  function showSOPModal(encodedSop) {
  try {
    const sop = JSON.parse(decodeURIComponent(encodedSop));
    document.getElementById('sop-modal-title').textContent = 'SOP';

    // Left align, show plain text instead of link
    document.getElementById('sop-modal-body').innerHTML = `
      <div class="mb-2 text-left">
        ${sop.sop_link ? `<span class="text-white-800 text-m">${escapeHtml(sop.sop_link)}</span>` : '-'}
      </div>
    `;

    document.getElementById('sop-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  } catch (err) {
    console.error('Failed to parse SOP JSON:', err);
    alert('Unable to open SOP details.');
  }
}

  function hideSOPModal() {
    document.getElementById('sop-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  function openEditModal(sop) {
    document.getElementById('crud-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    document.getElementById('edit-sop-id').value = sop.id;
    document.getElementById('edit-sop-alert').value = sop.alert_name || '';
    document.getElementById('edit-sop-title').value = sop.sop_title || '';
    document.getElementById('edit-sop-description').value = sop.sop_description || '';
    document.getElementById('edit-sop-link').value = sop.sop_link || '';
    
    // 🌟 ADDED NEW FIELDS HERE 🌟
    document.getElementById('edit-sop-daemon-tool-service').value = sop.daemon_tool_service || '';
    document.getElementById('edit-sop-script-summary').value = sop.script_summary || '';
    
    // Note: The service/version fields below assume they are filled correctly
    // based on the structure of the data passed from the backend, 
    // which may require mapping the service ID/version if the fields expect a specific format.
    document.getElementById('edit-sop-service').value = sop.service || '';
    document.getElementById('edit-sop-version').value = sop.version || '';
}

  function hideEditModal() {
    document.getElementById('crud-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

 function submitEditSOP(event) {
  event.preventDefault();

  const id = document.getElementById('edit-sop-id').value;

  // Collect fields
  const payload = {
    alert: document.getElementById('edit-sop-alert').value.trim(),
    sop_title: document.getElementById('edit-sop-title').value.trim(),
    sop_description: document.getElementById('edit-sop-description').value.trim(),
    sop_link: document.getElementById('edit-sop-link').value.trim(),
    
    // 🌟 ADDED NEW FIELDS 🌟
    daemon_tool_service: document.getElementById('edit-sop-daemon-tool-service').value.trim(),
    script_summary: document.getElementById('edit-sop-script-summary').value.trim(),
    
    last_modified_by: document.getElementById('edit-sop-modified-by').value // ✅ This sends the user_id
  };

  // Only include service_id if provided
  const serviceId = document.getElementById('edit-sop-service')?.value;
  if (serviceId && serviceId.trim() !== "") {
    payload.service_id = serviceId;
  }

  fetch(`http://127.0.0.1:5000/sops/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  })
    .then(async response => {
      const text = await response.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("Non-JSON response: " + text);
      }
      if (!response.ok) {
        throw new Error(data.error || "Update failed");
      }
      alert(data.message || 'SOP updated successfully! 🎉');
      hideEditModal();
      location.reload();
    })
    .catch(err => {
      console.error('Update failed:', err);
      alert('Something went wrong while updating SOP: ' + err.message);
    });
}


  // dropdown functionality 
   async function populateUsersDropdown() {
    const dropdown = document.getElementById("edit-sop-modified-by");

    try {
      const response = await fetch("http://192.168.64.1:5000/users"); // replace with your actual backend URL
      if (!response.ok) throw new Error("Failed to fetch users");

      const users = await response.json();

      // Clear existing options except the placeholder
      dropdown.innerHTML = '<option value="">Select a user</option>';

      // Add options dynamically
      users.forEach(user => {
        const option = document.createElement("option");
        option.value = user.id;          // store user ID
        option.textContent = user.username; // show username
        dropdown.appendChild(option);
      });

    } catch (error) {
      console.error("Error fetching users:", error);
    }
  }

  // Call the function when the page loads
  window.addEventListener("DOMContentLoaded", populateUsersDropdown);


  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  //  Toast Notification
  function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const bgColor = type === "success" 
      ? "text-green-500 bg-green-100 dark:bg-green-800 dark:text-green-200" 
      : "text-red-500 bg-red-100 dark:bg-red-800 dark:text-red-200";

    const toast = document.createElement("div");
    toast.className = "flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow-sm dark:text-gray-400 dark:bg-gray-800";
    toast.role = "alert";
    toast.innerHTML = `
      <div class="inline-flex items-center justify-center shrink-0 w-8 h-8 ${bgColor} rounded-lg">
        ✅
      </div>
      <div class="ms-3 text-sm font-normal">${message}</div>
      <button type="button" class="ms-auto -mx-1.5 -my-1.5 text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 dark:text-gray-500 dark:hover:text-white dark:hover:bg-gray-700 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
        <span class="sr-only">Close</span> ✖
      </button>
    `;

    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 4000);
  }

  // refresh functionality 
   const form = document.getElementById('search-form');
  const refreshContainer = document.getElementById('refresh-container');
  const refreshButton = document.getElementById('refresh-button');

  // Show refresh button after search
  form.addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent actual form submission for demo
    // Perform your search logic here
    console.log("Search submitted:", document.getElementById('default-search').value);

    // Show the refresh button
    refreshContainer.style.display = 'block';
  });

  // Refresh page and hide button again
  refreshButton.addEventListener('click', function() {
    window.location.reload(); // Refresh the page
    refreshContainer.style.display = 'none'; // Will not be visible after reload anyway
  });

  fetchGroupedSOPs();
</script>

<!--Script Summary Modal-->
<div 
    id="script-summary-modal" 
    tabindex="-1" 
    aria-hidden="true" 
    class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    
    <div class="relative p-4 w-full max-w-7xl max-h-full">
        <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                <h3 id="modal-summary-title" class="text-xl font-semibold text-gray-900 dark:text-white">
                    Script Summary
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="hideScriptSummaryModal()">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <div id="modal-summary-body" class="p-4 md:p-5 space-y-4">
                <p class="text-base leading-relaxed text-gray-500 dark:text-gray-400">Loading summary...</p> 
            </div>
            <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600 justify-end">
                <button onclick="hideScriptSummaryModal()" type="button" class="py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SOP Modal -->
<div id="sop-modal" tabindex="-1" aria-hidden="true" 
     class="hidden fixed inset-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-60">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative border border-gray-300 rounded-lg bg-gray-50 dark:border-gray-600 dark:bg-gray-800">
      
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-4 md:p-5 border-b border-gray-300 dark:border-gray-600">
        <h3 id="sop-modal-title" class="text-lg font-medium text-gray-800 dark:text-gray-300">
          SOP
        </h3>
        <button type="button" onclick="hideSOPModal()" 
                class="text-gray-800 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-sm w-8 h-8 flex items-center justify-center">
          ✕
        </button>
      </div>
      
      <!-- Modal Body -->
      <div id="sop-modal-body" class="p-4 md:p-5 text-left text-gray-800 dark:text-gray-300 whitespace-pre-line"></div>
    </div>
  </div>
</div>





  <!-- Edit SOP Modal -->
<div id="crud-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-60">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Edit SOP
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="hideEditModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <form id="edit-sop-form" class="p-4 md:p-5 space-y-4" onsubmit="submitEditSOP(event)">
        <input type="hidden" id="edit-sop-id" />
        
        <div>
          <label for="edit-sop-alert" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Alert Name</label>
          <input type="text" id="edit-sop-alert" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
        </div>
        
        <div>
          <label for="edit-sop-title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Title</label>
          <input type="text" id="edit-sop-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
        </div>
        
        <div>
          <label for="edit-sop-description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Description</label>
          <textarea id="edit-sop-description" rows="2" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border 
                 border-gray-300 focus:ring-blue-500 focus:border-blue-500 
                 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required></textarea>
        </div>

        <div>
          <label for="edit-sop-link" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">SOP Link</label>
          <textarea id="edit-sop-link" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border 
                 border-gray-300 focus:ring-blue-500 focus:border-blue-500 
                 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
        </div>
        
        <div>
          <label for="edit-sop-daemon-tool-service" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Daemon Tool Service</label>
          <input type="text" id="edit-sop-daemon-tool-service" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white">
        </div>

        <div>
          <label for="edit-sop-script-summary" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Script Summary</label>
          <textarea id="edit-sop-script-summary" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border 
                 border-gray-300 focus:ring-blue-500 focus:border-blue-500 
                 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
        </div>

        <div>
          <label for="edit-sop-modified-by" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Modified By
          </label>
          <select id="edit-sop-modified-by" 
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg 
                         focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 
                         dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" 
                  required>
            <option value="">Select a user</option>
            <option value="user1">User 1</option>
            <option value="user2">User 2</option>
            <!-- <option value="user3">User 3</option> -->
          </select>
        </div>


        <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
          Update
        </button>
      </form>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  <script src="services_dropdown.js" defer></script>
  <script src="add_service.js" defer></script>
  <script src="add_sop.js" defer></script>
  <script src="show_summary.js" defer></script>
</body>
</html>